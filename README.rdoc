## Redmine Tx Office365 í”ŒëŸ¬ê·¸ì¸ ì‚¬ìš© ë§¤ë‰´ì–¼

ì´ í”ŒëŸ¬ê·¸ì¸ì€ **Microsoft Graph API**ë¥¼ ì‚¬ìš©í•˜ì—¬ SharePoint/OneDrive ë¬¸ì„œ ì—°ë™ ë° Outlook ì¼ì • ê´€ë¦¬ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

í˜„ì¬ êµ¬í˜„ì€ **Client Credentials Flow(ì•± ê¶Œí•œ, Application permission)** ê¸°ë°˜ì…ë‹ˆë‹¤.

---

## 1) Azure ì„¤ì •

ì´ í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € Microsoft Azure(Entra ID)ì—ì„œ ì•±ì„ ë“±ë¡í•˜ê³  í•„ìš”í•œ ê¶Œí•œì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.

### ğŸ“˜ ìƒì„¸ ì„¤ì • ê°€ì´ë“œ

Azure ì•± ë“±ë¡, Client Secret ë°œê¸‰, ê¶Œí•œ ì„¤ì •, ê´€ë¦¬ì ë™ì˜ ë“± Azure ê´€ë ¨ ëª¨ë“  ì„¤ì •ì€ ë³„ë„ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”:

**ğŸ‘‰ [MS_AZURE.md - Microsoft Azure ì„¤ì • ê°€ì´ë“œ](./MS_AZURE.md)**

### í•„ìš”í•œ ì •ë³´

Azure ì„¤ì • ì™„ë£Œ í›„ ë‹¤ìŒ 3ê°€ì§€ ê°’ì´ í•„ìš”í•©ë‹ˆë‹¤:

- **`TENANT_ID`**: Directory (tenant) ID
- **`CLIENT_ID`**: Application (client) ID  
- **`CLIENT_SECRET`**: Client secret value

### í”ŒëŸ¬ê·¸ì¸ì— ì„¤ì • ì ìš©

#### ë°©ë²• 1: Redmine í”ŒëŸ¬ê·¸ì¸ ì„¤ì • í™”ë©´ (ê¶Œì¥)

1. Redmine ê´€ë¦¬ì ë¡œê·¸ì¸
2. **ê´€ë¦¬** â†’ **í”ŒëŸ¬ê·¸ì¸** â†’ **Redmine Tx Office365 plugin** â†’ **ì„¤ì •**
3. ë°œê¸‰ë°›ì€ Azure ì •ë³´ ì…ë ¥

#### ë°©ë²• 2: í™˜ê²½ë³€ìˆ˜

```bash
export TENANT_ID="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
export CLIENT_ID="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
export CLIENT_SECRET="your-secret-value"
```

---

## 2) ì‹¤í–‰ ë°©ë²•

```bash
ruby /Users/testors/conv.rb
```

ì„±ê³µ ì‹œ ì˜ˆì‹œ ì¶œë ¥:
- Access Token ë°œê¸‰ ì„±ê³µ
- í† í° ê¸¸ì´
- ìœ íš¨ì‹œê°„(ì´ˆ)
- ì¶”ì¶œëœ GUID
- ìë™ ìƒì„±ëœ Embed URL

---

## 3) ë ˆë“œë§ˆì¸(Redmine)ì—ì„œ ì£¼ê¸° ì‹¤í–‰ ì‹œ ì°¸ê³ 

- ë¡œê¹…:
  - Redmine/Rails í™˜ê²½ì´ë©´ `Rails.logger`ë¡œ ê¸°ë¡ë©ë‹ˆë‹¤.
- í† í° ë§Œë£Œ ëŒ€ì‘:
  - API ìš”ì²­ì´ **401**ë¡œ ì‹¤íŒ¨í•˜ë©´ **í† í°ì„ 1íšŒ ì¬ë°œê¸‰ í›„ ë™ì¼ ìš”ì²­ì„ 1íšŒ ì¬ì‹œë„**í•©ë‹ˆë‹¤.
- ë©€í‹° í”„ë¡œì„¸ìŠ¤ í™˜ê²½:
  - í† í°ì€ `Rails.cache`ì— ì €ì¥ë˜ì–´ ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ê³µìœ í•©ë‹ˆë‹¤.

---

## 4) TxGraph ì‚¬ìš© ì˜ˆì œ

### 4.1) TokenManager ì´ˆê¸°í™” ë° í† í° ë°œê¸‰

#### ë°©ë²• 1: ë ˆë“œë§ˆì¸ í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ìë™ ì‚¬ìš© (ê¶Œì¥)

```ruby
require_relative 'lib/tx_graph'

# í”ŒëŸ¬ê·¸ì¸ ì„¤ì •(tenant_id, client_id, client_secret)ì„ ìë™ìœ¼ë¡œ ì‚¬ìš©
token_manager = TxGraph::Auth::TokenManager.new

# í† í° ê°€ì ¸ì˜¤ê¸° (í•„ìš”ì‹œ ìë™ ë°œê¸‰/ê°±ì‹ )
access_token = token_manager.token
puts "Access Token: #{access_token[0..50]}..."

# í† í° ë‚¨ì€ ì‹œê°„ í™•ì¸
puts "í† í° ìœ íš¨ì‹œê°„: #{token_manager.expires_in}ì´ˆ"

# ê°•ì œ ê°±ì‹ 
token_manager.force_refresh!
```

#### ë°©ë²• 2: ìˆ˜ë™ìœ¼ë¡œ ì¸ì¦ ì •ë³´ ì§€ì •

```ruby
# TokenManager ìƒì„± (í”ŒëŸ¬ê·¸ì¸ ì„¤ì •ê³¼ ë³„ë„ë¡œ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ë•Œ)
token_manager = TxGraph::Auth::TokenManager.new(
  tenant_id: ENV['TENANT_ID'],
  client_id: ENV['CLIENT_ID'],
  client_secret: ENV['CLIENT_SECRET'],
  scope: 'https://graph.microsoft.com/.default',
  refresh_skew: 60  # ë§Œë£Œ 60ì´ˆ ì „ì— ìë™ ê°±ì‹ 
)
```

### 4.2) SharePoint ê³µìœ  ë§í¬ â†’ GUID ë³€í™˜

```ruby
# LinkConverter ì´ˆê¸°í™” (í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ìë™ ì‚¬ìš©)
converter = TxGraph::SharePoint::LinkConverter.new

# SharePoint ê³µìœ  ë§í¬ì—ì„œ GUID ì¶”ì¶œ
sharing_url = "https://yourcompany.sharepoint.com/:p:/r/sites/YourSite/_layouts/15/Doc.aspx?sourcedoc=%7B1DA5CF75-88CB-49E7-9596-E4F4ABDC76CF%7D&action=edit"
guid = converter.get_guid_from_url(sharing_url)

if guid
  puts "ì¶”ì¶œëœ GUID: #{guid}"
  # PowerPoint Embed URL ìƒì„±
  embed_url = "https://yourcompany.sharepoint.com/sites/YourSite/_layouts/15/embed.aspx?uniqueid=#{guid}"
  puts "Embed URL: #{embed_url}"
else
  puts "GUID ì¶”ì¶œ ì‹¤íŒ¨"
end
```

### 4.3) Outlook ì¼ì • ìƒì„±

```ruby
# EventService ì´ˆê¸°í™” (í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ìë™ ì‚¬ìš©)
event_service = TxGraph::Outlook::Calendar::EventService.new

# ì¼ì • ìƒì„±
event = event_service.create_event(
  user_id: 'user@yourcompany.com',  # UPN ë˜ëŠ” User Object ID
  subject: 'íŒ€ ë¯¸íŒ…',
  start_at: '2025-12-24T10:00:00',
  end_at: '2025-12-24T11:00:00',
  time_zone: 'Asia/Seoul',
  body: '<p>í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™© ê³µìœ </p>',
  location: 'íšŒì˜ì‹¤ A',
  attendees: [
    { email: 'member1@yourcompany.com', name: 'ê¹€ì² ìˆ˜', type: 'required' },
    { email: 'member2@yourcompany.com', name: 'ì´ì˜í¬', type: 'optional' }
  ]
)

if event
  puts "ì¼ì • ìƒì„± ì„±ê³µ: #{event['id']}"
  puts "ì›¹ ë§í¬: #{event['webLink']}"
else
  puts "ì¼ì • ìƒì„± ì‹¤íŒ¨"
end
```

### 4.4) Outlook ì¼ì • ì‚­ì œ

```ruby
# ìƒì„±ëœ ì¼ì • ì‚­ì œ
success = event_service.delete_event(
  user_id: 'user@yourcompany.com',
  event_id: event['id']
)

if success
  puts "ì¼ì • ì‚­ì œ ì™„ë£Œ"
else
  puts "ì¼ì • ì‚­ì œ ì‹¤íŒ¨"
end
```

### 4.5) Http Client ì§ì ‘ ì‚¬ìš©

```ruby
# ì €ìˆ˜ì¤€ HTTP í´ë¼ì´ì–¸íŠ¸ ì‚¬ìš© (ì»¤ìŠ¤í…€ API í˜¸ì¶œ, í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ìë™ ì‚¬ìš©)
client = TxGraph::Http::Client.new

# GET ìš”ì²­
status, body = client.get('/me')
if status == '200'
  user = JSON.parse(body)
  puts "ì‚¬ìš©ì: #{user['displayName']}"
end

# POST ìš”ì²­
status, body = client.post(
  '/users/user@yourcompany.com/messages',
  json_body: {
    subject: 'í…ŒìŠ¤íŠ¸ ë©”ì¼',
    body: { contentType: 'Text', content: 'í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.' },
    toRecipients: [{ emailAddress: { address: 'recipient@example.com' } }]
  }
)
```

### 4.6) ë ˆë“œë§ˆì¸ í”ŒëŸ¬ê·¸ì¸ì—ì„œ ì‚¬ìš©

```ruby
# ì»¨íŠ¸ë¡¤ëŸ¬ë‚˜ ëª¨ë¸ì—ì„œ ì§ì ‘ ì‚¬ìš© (í”ŒëŸ¬ê·¸ì¸ ì„¤ì • ìë™ ì ìš©)
class AttendancesController < ApplicationController
  def create_calendar_event
    # EventServiceê°€ ìë™ìœ¼ë¡œ í”ŒëŸ¬ê·¸ì¸ ì„¤ì •ì„ ì½ì–´ì„œ ì´ˆê¸°í™”ë¨
    event_service = TxGraph::Outlook::Calendar::EventService.new
    
    event = event_service.create_event(
      user_id: User.current.mail,
      subject: "ê·¼ë¬´: #{@attendance.work_date}",
      start_at: @attendance.start_time,
      end_at: @attendance.end_time,
      time_zone: 'Asia/Seoul'
    )
    
    if event
      @attendance.update(calendar_event_id: event['id'])
      flash[:notice] = 'ì¼ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'
    else
      flash[:error] = 'ì¼ì • ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    end
  end
  
  def delete_calendar_event
    event_service = TxGraph::Outlook::Calendar::EventService.new
    
    if event_service.delete_event(
      user_id: User.current.mail,
      event_id: @attendance.calendar_event_id
    )
      @attendance.update(calendar_event_id: nil)
      flash[:notice] = 'ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    else
      flash[:error] = 'ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
    end
  end
end

# SharePoint ë§í¬ ë³€í™˜ ì˜ˆì œ
class IssuesController < ApplicationController
  def show
    # ì´ìŠˆ ì„¤ëª…ì—ì„œ SharePoint ë§í¬ë¥¼ ì°¾ì•„ GUID ì¶”ì¶œ
    converter = TxGraph::SharePoint::LinkConverter.new
    
    @issue.description.scan(/https:\/\/.*sharepoint\.com[^\s]+/).each do |link|
      guid = converter.get_guid_from_url(link)
      # GUIDë¥¼ ì´ìš©í•œ í›„ì† ì²˜ë¦¬...
    end
  end
end
```

---

## 5) Office365Storage (Key-Value ìŠ¤í† ë¦¬ì§€)

í”ŒëŸ¬ê·¸ì¸ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì˜êµ¬ Key-Value ìŠ¤í† ë¦¬ì§€ì…ë‹ˆë‹¤. ì„¤ì •ê°’, ìºì‹œ, ìƒíƒœ ë“±ì„ ì €ì¥í•˜ëŠ”ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 5.1) ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

```bash
cd /Users/testors/redmine-ssr/redmine-dev
bundle exec rake redmine:plugins:migrate NAME=redmine_tx_office365 RAILS_ENV=production
```

### 5.2) ê¸°ë³¸ ì‚¬ìš©ë²•

```ruby
# ê°’ ì €ì¥
Office365Storage.set('last_sync_time', Time.now, description: 'ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê°')
Office365Storage.set('sync_count', 100)
Office365Storage.set('is_enabled', true)
Office365Storage.set('config', { api_version: 'v1.0', timeout: 30 })

# ê°’ ì¡°íšŒ
last_sync = Office365Storage.get('last_sync_time')  # Time ê°ì²´ ë°˜í™˜
count = Office365Storage.get('sync_count')          # 100
enabled = Office365Storage.get('is_enabled')        # true
config = Office365Storage.get('config')             # Hash ë°˜í™˜

# ê°’ ì‚­ì œ
Office365Storage.delete('old_key')

# í‚¤ ì¡´ì¬ í™•ì¸
if Office365Storage.exists?('last_sync_time')
  # ì²˜ë¦¬...
end
```

### 5.3) ì—¬ëŸ¬ ê°’ í•œë²ˆì— ì²˜ë¦¬

```ruby
# ì—¬ëŸ¬ ê°’ ì¡°íšŒ
values = Office365Storage.get_multi('key1', 'key2', 'key3')
# => { 'key1' => value1, 'key2' => value2, 'key3' => value3 }

# ì—¬ëŸ¬ ê°’ ì €ì¥
Office365Storage.set_multi({
  'setting1' => 'value1',
  'setting2' => 'value2',
  'setting3' => 'value3'
}, description: 'ì¼ê´„ ì„¤ì •')

# ëª¨ë“  í‚¤ ì¡°íšŒ
all_keys = Office365Storage.keys
# => ['last_sync_time', 'sync_count', 'is_enabled', ...]
```

### 5.4) ìˆ«ì ì¦ê°

```ruby
# ì¹´ìš´í„° ì¦ê°€
Office365Storage.set('api_call_count', 0)
Office365Storage.increment('api_call_count')      # 1
Office365Storage.increment('api_call_count', by: 5)  # 6

# ì¹´ìš´í„° ê°ì†Œ
Office365Storage.decrement('api_call_count')      # 5
Office365Storage.decrement('api_call_count', by: 3)  # 2
```

### 5.5) ì‹¤ì œ ì‚¬ìš© ì˜ˆì œ

```ruby
# ë™ê¸°í™” ìƒíƒœ ê´€ë¦¬
class Office365SyncService
  def sync_calendars
    # ë§ˆì§€ë§‰ ë™ê¸°í™” ì‹œê° í™•ì¸
    last_sync = Office365Storage.get('calendar_last_sync')
    
    if last_sync && (Time.now - last_sync) < 5.minutes
      Rails.logger.info "ìµœê·¼ì— ë™ê¸°í™”ë¨: #{last_sync}"
      return
    end
    
    # ë™ê¸°í™” ì‹¤í–‰
    begin
      event_service = TxGraph::Outlook::Calendar::EventService.new
      # ... ë™ê¸°í™” ë¡œì§ ...
      
      # ì„±ê³µ ì‹œ ì‹œê° ì €ì¥
      Office365Storage.set('calendar_last_sync', Time.now)
      Office365Storage.increment('calendar_sync_success_count')
    rescue => e
      Office365Storage.increment('calendar_sync_error_count')
      Rails.logger.error "ë™ê¸°í™” ì‹¤íŒ¨: #{e.message}"
    end
  end
end

# API í˜¸ì¶œ ì œí•œ ê´€ë¦¬
class Office365RateLimiter
  def can_call_api?
    count = Office365Storage.get('api_calls_today') || 0
    limit = Office365Storage.get('api_daily_limit') || 5000
    
    count < limit
  end
  
  def record_api_call
    # ì˜¤ëŠ˜ ë‚ ì§œë¥¼ í‚¤ì— í¬í•¨
    key = "api_calls_#{Date.today.strftime('%Y%m%d')}"
    Office365Storage.increment(key)
  end
end

# ê¸°ëŠ¥ í”Œë˜ê·¸
class FeatureFlags
  def self.calendar_sync_enabled?
    Office365Storage.get('feature_calendar_sync_enabled') || false
  end
  
  def self.enable_calendar_sync!
    Office365Storage.set('feature_calendar_sync_enabled', true)
  end
  
  def self.disable_calendar_sync!
    Office365Storage.set('feature_calendar_sync_enabled', false)
  end
end
```

### 5.6) ì§€ì›ë˜ëŠ” ë°ì´í„° íƒ€ì…

- **String**: ì¼ë°˜ ë¬¸ìì—´
- **Integer**: ì •ìˆ˜
- **Float**: ë¶€ë™ì†Œìˆ˜ì 
- **Boolean**: true/false
- **Hash/Array**: JSONìœ¼ë¡œ ì§ë ¬í™”ë˜ì–´ ì €ì¥

---

## 6) ì´ìŠˆ ìë™ SharePoint ì—°ë™

ë ˆë“œë§ˆì¸ ì´ìŠˆì— SharePoint URLì´ í¬í•¨ë˜ë©´ ìë™ìœ¼ë¡œ GUIDë¥¼ ì¶”ì¶œí•˜ì—¬ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

### 6.1) ìë™ ë™ì‘

**Controller Hooks ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤:**
- `controller_issues_new_before_save` - ì´ìŠˆ ìƒì„± ì „
- `controller_issues_edit_before_save` - ì´ìŠˆ ìˆ˜ì • ì „
- `controller_issues_bulk_edit_before_save` - ì´ìŠˆ ì¼ê´„ ìˆ˜ì • ì „
- `controller_issues_new_after_save` - ì´ìŠˆ ìƒì„± í›„ (ìƒˆ ì´ìŠˆì˜ ID í™•ì • í›„ GUID ì €ì¥)

ì´ìŠˆë¥¼ ìƒì„±í•˜ê±°ë‚˜ ë³¸ë¬¸(description)ì„ ìˆ˜ì •í•  ë•Œ, SharePoint URLì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´:
1. TxGraph::SharePoint::LinkConverterë¡œ ìë™ìœ¼ë¡œ GUID ì¶”ì¶œ
2. Office365Storageì— `DOC.[ì´ìŠˆID]` í‚¤ë¡œ GUID ì €ì¥
3. ë¡œê·¸ì— ì„±ê³µ/ì‹¤íŒ¨ ë©”ì‹œì§€ ê¸°ë¡

**ì¥ì :**
- Issue ëª¨ë¸ì„ ì§ì ‘ ìˆ˜ì •í•˜ì§€ ì•Šì•„ í”ŒëŸ¬ê·¸ì¸ ì œê±° ì‹œ ê¹”ë”í•¨
- Redmineì˜ í‘œì¤€ í™•ì¥ ë°©ì‹ ì‚¬ìš©
- ë‹¤ë¥¸ í”ŒëŸ¬ê·¸ì¸ê³¼ì˜ ì¶©ëŒ ê°€ëŠ¥ì„± ìµœì†Œí™”

**ì§€ì›ë˜ëŠ” URL í˜•ì‹:**
```
https://supercreative.sharepoint.com/:p:/g/IQB1z6Udy4jnSZWW5PSr3HbPAULbh0gcOxAePDOuglzWHcE?e=I7OJwS
https://yourcompany.sharepoint.com/:f:/r/sites/YourSite/Documents/file.xlsx?sourcedoc=%7BGUID%7D
https://example.sharepoint.com/sites/ProjectA/_layouts/15/Doc.aspx?sourcedoc={GUID}
```

### 6.2) í—¬í¼ ë©”ì†Œë“œ

Issue ëª¨ë¸ì— ì¶”ê°€ëœ ë©”ì†Œë“œë“¤:

```ruby
# ì´ìŠˆì— ì—°ê²°ëœ SharePoint ë¬¸ì„œì˜ GUID ì¡°íšŒ
@issue.sharepoint_guid
# => "1DA5CF75-88CB-49E7-9596-E4F4ABDC76CF"

# SharePoint ë¬¸ì„œê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
@issue.has_sharepoint_document?
# => true

# Embed URL ìƒì„± (PowerPoint, Excel ë“± ë¯¸ë¦¬ë³´ê¸°ìš©)
@issue.sharepoint_embed_url(site_url: "https://supercreative.sharepoint.com/sites/YourSite")
# => "https://supercreative.sharepoint.com/sites/YourSite/_layouts/15/embed.aspx?uniqueid=1DA5CF75-..."

# ì €ì¥ëœ GUID ì‚­ì œ
@issue.clear_sharepoint_guid
```

### 6.3) ìë™ ë¬¸ì„œ í‘œì‹œ (View Hook)

**í”ŒëŸ¬ê·¸ì¸ì´ ìë™ìœ¼ë¡œ ì´ìŠˆ ìƒì„¸ í˜ì´ì§€ì— SharePoint ë¬¸ì„œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.**

1. **í”ŒëŸ¬ê·¸ì¸ ì„¤ì •ì—ì„œ SharePoint ì‚¬ì´íŠ¸ URL ì„¤ì •**
   - ê´€ë¦¬ > í”ŒëŸ¬ê·¸ì¸ > Redmine Tx Office365 plugin > ì„¤ì •
   - "SharePoint Site URL" ì…ë ¥ (ì˜ˆ: `https://supercreative.sharepoint.com/sites/YourSite`)

2. **ìë™ í‘œì‹œ ìœ„ì¹˜**
   - ì´ìŠˆ ìƒì„¸ í˜ì´ì§€ì˜ ë³¸ë¬¸(Description) í•˜ë‹¨
   - `Office365Storage`ì— `DOC.[ì´ìŠˆID]` í‚¤ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ iframe í‘œì‹œ

3. **í‘œì‹œë˜ëŠ” ë‚´ìš©**
   - SharePoint ë¬¸ì„œ ì œëª©
   - 600px ë†’ì´ì˜ iframe (PowerPoint, Excel, Word ë“± ë¯¸ë¦¬ë³´ê¸°)
   - ë¬¸ì„œ GUID (ì½”ë“œ ë¸”ë¡)
   - "SharePointì—ì„œ ì—´ê¸°" ë§í¬ (ìƒˆ ì°½)

**ìë™ í‘œì‹œ ë¹„í™œì„±í™”:**

View Hookì„ ë¹„í™œì„±í™”í•˜ë ¤ë©´ `lib/tx_office365_hooks.rb`ì—ì„œ `view_issues_show_description_bottom` ë©”ì†Œë“œë¥¼ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œí•˜ì„¸ìš”.

### 6.4) ë·°ì—ì„œ ìˆ˜ë™ ì‚¬ìš© (í—¬í¼ ë©”ì†Œë“œ)

ìë™ í‘œì‹œ ì™¸ì— ë‹¤ë¥¸ ìœ„ì¹˜ì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´:

```erb
<!-- í—¬í¼ ë©”ì†Œë“œë¡œ ê°„ë‹¨í•˜ê²Œ -->
<%= sharepoint_document_box(@issue, site_url: 'https://supercreative.sharepoint.com/sites/YourSite') %>

<!-- ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ -->
<% if @issue.has_sharepoint_document? %>
  <div class="box">
    <h3>ì—°ê²°ëœ SharePoint ë¬¸ì„œ</h3>
    <div class="sharepoint-embed">
      <iframe 
        src="<%= @issue.sharepoint_embed_url(site_url: 'https://supercreative.sharepoint.com/sites/YourSite') %>" 
        width="100%" 
        height="600px" 
        frameborder="0">
      </iframe>
    </div>
    <p>
      <strong>ë¬¸ì„œ GUID:</strong> <%= @issue.sharepoint_guid %>
    </p>
  </div>
<% end %>
```

**ì´ìŠˆ ëª©ë¡ì—ì„œ SharePoint ë¬¸ì„œ ì•„ì´ì½˜ í‘œì‹œ:**

```erb
<!-- í—¬í¼ ë©”ì†Œë“œ ì‚¬ìš© -->
<%= sharepoint_document_icon(@issue) %>

<!-- ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ -->
<% if issue.has_sharepoint_document? %>
  <span class="icon icon-file" title="SharePoint ë¬¸ì„œ ì—°ê²°ë¨"></span>
<% end %>
```

### 6.5) ì»¨íŠ¸ë¡¤ëŸ¬/ëª¨ë¸ì—ì„œ ì‚¬ìš©

```ruby
# ì´ìŠˆ ìƒì„± í›„ SharePoint GUID í™•ì¸
class IssuesController < ApplicationController
  def create
    @issue = Issue.new(issue_params)
    
    if @issue.save
      # ìë™ìœ¼ë¡œ SharePoint GUIDê°€ ì¶”ì¶œë˜ì–´ ì €ì¥ë¨
      if @issue.has_sharepoint_document?
        flash[:notice] = "ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. SharePoint ë¬¸ì„œê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."
      else
        flash[:notice] = "ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤."
      end
    end
  end
end

# ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ ëª¨ë“  ì´ìŠˆì˜ SharePoint GUID ì¡°íšŒ
class SharePointReportService
  def generate_document_report
    issues_with_docs = Issue.all.select(&:has_sharepoint_document?)
    
    issues_with_docs.each do |issue|
      puts "Issue ##{issue.id}: #{issue.subject}"
      puts "  GUID: #{issue.sharepoint_guid}"
      puts "  Embed: #{issue.sharepoint_embed_url(site_url: site_url)}"
    end
  end
end
```

### 6.6) ì €ì¥ í‚¤ êµ¬ì¡°

Office365Storageì— ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤:

```ruby
# í‚¤: "DOC.[ì´ìŠˆID]"
# ê°’: SharePoint ë¬¸ì„œ GUID
# ì„¤ëª…: "Issue #123: í”„ë¡œì íŠ¸ ê¸°íšì„œ ì‘ì„±"

Office365Storage.get("DOC.123")
# => "1DA5CF75-88CB-49E7-9596-E4F4ABDC76CF"

# ëª¨ë“  SharePoint ì—°ê²° ì¡°íšŒ
all_docs = Office365Storage.where("key LIKE ?", "DOC.%")
```

### 6.7) ë¡œê·¸ í™•ì¸

```bash
# production.logì—ì„œ SharePoint ê´€ë ¨ ë¡œê·¸ í™•ì¸
tail -f log/production.log | grep "Office365"

# ì„±ê³µ ì˜ˆì‹œ:
# Office365: Issue #123ì—ì„œ SharePoint GUID ì €ì¥ë¨: 1DA5CF75-88CB-49E7-9596-E4F4ABDC76CF

# ì‹¤íŒ¨ ì˜ˆì‹œ:
# Office365: Issue #123ì—ì„œ SharePoint URLì˜ GUID ì¶”ì¶œ ì‹¤íŒ¨: https://...
```

### 6.8) ê¸°ìˆ  êµ¬í˜„

**íŒŒì¼ êµ¬ì¡°:**
- `lib/tx_office365_hooks.rb` - Controller Hook êµ¬í˜„ì²´
  - SharePoint URL ê°ì§€ ë° GUID ì¶”ì¶œ ë¡œì§
  - ìƒˆ ì´ìŠˆì˜ ê²½ìš° ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì— ì„ì‹œ ì €ì¥ í›„ `after_save`ì—ì„œ ì €ì¥
- `lib/tx_office365_issue_patch.rb` - Issue ëª¨ë¸ í—¬í¼ ë©”ì†Œë“œ
  - `sharepoint_guid`, `has_sharepoint_document?` ë“± ì½ê¸° ì „ìš© ë©”ì†Œë“œë§Œ ì¶”ê°€
  - ì €ì¥ ë¡œì§ì€ í¬í•¨í•˜ì§€ ì•ŠìŒ

**ë™ì‘ ìˆœì„œ:**
1. ì´ìŠˆ ìƒì„±/ìˆ˜ì • ì‹œ `before_save` Hook ì‹¤í–‰
2. SharePoint URL íŒ¨í„´ ë§¤ì¹­: `/https://[^/\s]+\.sharepoint\.com/[^\s]+/`
3. GUID ì¶”ì¶œ (TxGraph API í˜¸ì¶œ)
4. ì‹ ê·œ ì´ìŠˆ: `@pending_sharepoint_guid` ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ì— ì„ì‹œ ì €ì¥
5. ê¸°ì¡´ ì´ìŠˆ: Office365Storageì— ì¦‰ì‹œ ì €ì¥
6. ì‹ ê·œ ì´ìŠˆì˜ ê²½ìš° `after_save` Hookì—ì„œ í™•ì •ëœ IDë¡œ ì €ì¥

**ì½˜ì†”ì—ì„œ í…ŒìŠ¤íŠ¸:**

Hook ë¡œì§ì€ í´ë˜ìŠ¤ ë©”ì†Œë“œë¡œ ë…¸ì¶œë˜ì–´ ìˆì–´ Rails ì½˜ì†”ì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ruby
# Rails ì½˜ì†” ì‹¤í–‰
cd /Users/testors/redmine-ssr/redmine-dev
bundle exec rails console

# í•œ ì¤„ë¡œ í…ŒìŠ¤íŠ¸
TxOffice365Hooks.extract_and_store_sharepoint_guid(Issue.find(123))

# ê²°ê³¼ í™•ì¸
issue = Issue.find(123)
puts "GUID: #{issue.sharepoint_guid}"
puts "ì—°ê²°ë¨: #{issue.has_sharepoint_document?}"

# SharePoint URLì´ í¬í•¨ëœ ì´ìŠˆë¡œ í…ŒìŠ¤íŠ¸
issue = Issue.find(123)
issue.description = "ë¬¸ì„œ: https://supercreative.sharepoint.com/:p:/g/IQB1z6Udy4jnSZWW5PSr3HbPAULbh0gcOxAePDOuglzWHcE"
TxOffice365Hooks.extract_and_store_sharepoint_guid(issue)
puts Office365Storage.get("DOC.#{issue.id}")

# ì „ì²´ í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸ (í•œ ì¤„)
issue = Issue.find(123); issue.description = "https://supercreative.sharepoint.com/:p:/g/test"; TxOffice365Hooks.extract_and_store_sharepoint_guid(issue); issue.sharepoint_guid
```

### 6.9) ì£¼ì˜ì‚¬í•­

- í”ŒëŸ¬ê·¸ì¸ ì„¤ì •ì—ì„œ `tenant_id`, `client_id`, `client_secret`ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
- Microsoft Graph API ê¶Œí•œ (`Sites.Read.All` ë˜ëŠ” `Files.Read.All`)ì´ ë¶€ì—¬ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤
- ì´ìŠˆ ë³¸ë¬¸ì— ì—¬ëŸ¬ SharePoint URLì´ ìˆì–´ë„ ì²« ë²ˆì§¸ URLë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤
- GUID ì¶”ì¶œì— ì‹¤íŒ¨í•´ë„ ì´ìŠˆ ì €ì¥ì€ ì •ìƒì ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤
- Controller Hook ë°©ì‹ì´ë¯€ë¡œ APIë‚˜ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì´ìŠˆë¥¼ ìƒì„±í•˜ë©´ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤

---

## 7) ë¬¸ì œ í•´ê²°(Troubleshooting)

### Azure ì„¤ì • ê´€ë ¨ ë¬¸ì œ

Azure ì•± ë“±ë¡, ê¶Œí•œ ì„¤ì •, ì¸ì¦ ê´€ë ¨ ë¬¸ì œëŠ” ë³„ë„ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”:

**ğŸ‘‰ [MS_AZURE.md - ë¬¸ì œ í•´ê²° ì„¹ì…˜](./MS_AZURE.md#8-ë¬¸ì œ-í•´ê²°-troubleshooting)**

ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ MS_AZURE.mdë¥¼ í™•ì¸í•˜ì„¸ìš”:
- `401 Unauthorized` - í† í° ë°œê¸‰ ì‹¤íŒ¨
- `403 Forbidden` - ê¶Œí•œ ë¶€ì¡±
- `AADSTS7000215` - Client Secret ì˜¤ë¥˜

### ìºì‹œ ê´€ë ¨ ì´ìŠˆ

**ë¬¸ì œ**: í† í°ì´ ì œëŒ€ë¡œ ê°±ì‹ ë˜ì§€ ì•ŠìŒ

**ì›ì¸**:
- `Rails.cache`ê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•ŠìŒ
- ìºì‹œ ìŠ¤í† ì–´ê°€ ì‘ë™í•˜ì§€ ì•ŠìŒ

**í•´ê²° ë°©ë²•**:
- ìºì‹œ ìŠ¤í† ì–´ í™•ì¸ (Redis, Memcached ë“±)
- ê°œë°œ í™˜ê²½ì—ì„œëŠ” ê¸°ë³¸ ë©”ëª¨ë¦¬ ìºì‹œ ì‚¬ìš©
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” Redis ë“± ì˜êµ¬ ìºì‹œ ê¶Œì¥

```ruby
# Rails ì½˜ì†”ì—ì„œ ìºì‹œ í™•ì¸
Rails.cache.write('test', 'value')
Rails.cache.read('test')  # => "value"
```

### SharePoint GUID ì¶”ì¶œ ì‹¤íŒ¨

**ë¬¸ì œ**: ì´ìŠˆì— SharePoint URLì„ ì…ë ¥í–ˆëŠ”ë° GUIDê°€ ì¶”ì¶œë˜ì§€ ì•ŠìŒ

**ì›ì¸**:
- URL í˜•ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŒ
- Microsoft Graph API ê¶Œí•œ ë¶€ì¡±
- íŒŒì¼ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ ê¶Œí•œì´ ì—†ìŒ

**í•´ê²° ë°©ë²•**:

1. ë¡œê·¸ í™•ì¸:
```bash
tail -f log/production.log | grep "Office365"
```

2. ì§€ì›ë˜ëŠ” URL í˜•ì‹ í™•ì¸ (ì„¹ì…˜ 6.1 ì°¸ì¡°)

3. Rails ì½˜ì†”ì—ì„œ ì§ì ‘ í…ŒìŠ¤íŠ¸:
```ruby
converter = TxGraph::SharePoint::LinkConverter.new
guid = converter.get_guid_from_url("your-sharepoint-url")
puts guid
```

### Office365Storage ê´€ë ¨ ë¬¸ì œ

**ë¬¸ì œ**: `Office365Storage` í…Œì´ë¸”ì´ ì—†ë‹¤ëŠ” ì—ëŸ¬

**ì›ì¸**: ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ

**í•´ê²° ë°©ë²•**:
```bash
cd /Users/testors/redmine-ssr/redmine-dev
bundle exec rake redmine:plugins:migrate NAME=redmine_tx_office365 RAILS_ENV=production
```

### ë¡œê·¸ í™•ì¸ ë°©ë²•

```bash
# ì „ì²´ ë¡œê·¸ í™•ì¸
tail -f log/production.log

# Office365 ê´€ë ¨ ë¡œê·¸ë§Œ í•„í„°ë§
tail -f log/production.log | grep -i "office365\|txgraph"

# ì—ëŸ¬ë§Œ í™•ì¸
tail -f log/production.log | grep -i "error\|exception"
```


